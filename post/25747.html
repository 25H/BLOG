<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><meta name=renderer content=webkit><meta name=force-rendering content=webkit><meta name=viewport content="width=device-width,minimum-scale=1,initial-scale=1"><meta http-equiv=cache-control content=no-transform><meta http-equiv=cache-control content=no-siteapp><meta name=generator content="Hugo 0.57.2"><meta name=author content=25H><meta name=copyright content=ARAE><meta name=robots content=all><meta name=keywords content=易语言,支持库><meta name=description content="易语言支持库升级之后，要保证向下兼容性，主要是做到以下几点： 一：保证原有的易语言源程序（.e）能正常打开（兼容点1）、正常编译（兼容点2）、编译结果正确（兼容点3）； 二：保证原有的易语言程序（.exe）能正常运行（兼容点4）、运行结果正确（兼容点5）。 这里说的“原有的易语言源程序”和“原有的易 …"><title>升级易语言支持库保证向下兼容性的几点总结 - ARAE</title><link rel=icon href=/images/favicon.png><link rel=canonical href=https://blog.arae.cc/post/25747.html><link rel=stylesheet href=/assets/style.min.css><script src=/assets/script.min.js></script></head><body><div id=kratos-wrapper><div id=kratos-page><div id=kratos-header><header id=kratos-header-section><div class=container><div class=nav-header><nav id=kratos-menu-wrap class=menu-main-container><ul id=kratos-primary-menu class=sf-menu><li class=current-menu-item><a href=/ aria-current=page><i class="fa fa-home"></i>&nbsp;首页</a></li><li><a href=/categories/%E7%8A%B6%E6%80%81.html><i class="fa fa-at"></i>&nbsp;状态</a></li><li><a href=javascript:;><i class="fa fa-folder-o"></i>&nbsp;分类</a><ul class=sub-menu><li><a href=/categories/code.html>Coding</a></li><li><a href=/categories/%E4%BD%9C%E5%93%81.html>作品</a></li><li><a href=/categories/%E7%AC%94%E8%AE%B0.html>笔记</a></li><li><a href=/categories/%E8%BD%AC%E8%BD%BD.html>转载</a></li><li><a href=/categories/%E6%9C%AA%E5%88%86%E7%B1%BB.html>未分类</a></li></ul></li><li><a href=/z/projects.html><i class="fa fa-bug"></i>&nbsp;项目</a></li><li><a href=/z/links.html><i class="fa fa-mars"></i>&nbsp;友链</a></li><li><a href=/z/about.html><i class="fa fa-rocket"></i>&nbsp;关于</a></li></ul></nav></div></div></header></div><div class="kratos-start kratos-hero-2"><div class=kratos-overlay></div><div class="kratos-cover kratos-cover_2 text-center"><div class="desc desc2 animate-box"><a href=https://blog.arae.cc/><h2>25H's Blog</h2><br><span>一个安静的角落</span></a></div></div></div><div id=kratos-blog-post style=background:#f5f5f5><div id=container class=container style=opacity:1><div class=row><section id=main class=col-md-8><article><div class="kratos-hentry kratos-post-inner clearfix"><header class=kratos-entry-header><h1 class="kratos-entry-title text-center">升级易语言支持库保证向下兼容性的几点总结</h1><div class="kratos-post-meta text-center"><span title="2016-09-29 15:24:11"><i class="fa fa-calendar"></i>&nbsp;2016年09月29日</span>
<span><i class="fa fa-folder-o"></i>&nbsp;<a class=label href=/categories/%E6%9C%AA%E5%88%86%E7%B1%BB.html>未分类</a></span><span title="文章字数： ≈ 2198 字"><i class="fa fa-file-word-o"></i>&nbsp;2.20k</span>
<span title="阅读时长： ≈ 5 分钟"><i class="fa fa-clock-o"></i>&nbsp;5min</span>
<span><i class="fa fa-user"></i>&nbsp;25H</span></div></header><div class=kratos-post-content><p>易语言支持库升级之后，要保证向下兼容性，主要是做到以下几点：<br>一：保证原有的易语言源程序（.e）能正常打开（兼容点1）、正常编译（兼容点2）、编译结果正确（兼容点3）；<br>二：保证原有的易语言程序（.exe）能正常运行（兼容点4）、运行结果正确（兼容点5）。<br>这里说的“原有的易语言源程序”和“原有的易语言程序”是指，替换新版支持库文件之前，使用旧版支持库编写的易语言源程序，和使用该源程序编译生成的可执行程序。</p><p>本文主要就此问题结合具体情况进行分析和总结。</p><h3 id=一-为支持库增加一条命令>一，为支持库增加一条命令</h3><p>新增加的命令，必须放在所有原有命令的后面，否则将违反兼容点2和4，更无法保证兼容点3和5。这是因为，在源程序和EXE中，记录的都是命令的索引，一旦在中间插入一条命令，将导致后面的命令索引全变了，进而导致非常严重的错位问题。只要记住，总是在所有命令的最后添加新的命令，就不会引入兼容性问题。具体到数据类型的成员方法，与上面的分种一致，因为它也是使用支持库中唯一的全局函数表的，但这里引入了一个新的细节，有一个 LIB_DATA_TYPE_INFO.m_pnCmdsIndex 用于指定方法在全局函数表中的命令索引，所以通过它可以调整各成员方法的顺序，这种做法通常不会引入兼容性问题。</p><h3 id=二-为命令增加一个参数-或修改命令的参数>二，为命令增加一个参数，或修改命令的参数</h3><p>新增加的参数，必须放在所有参数的后面，否则将违反兼容点2,3,4,5；必须允许省略该参数（AS_DEFAULT_VALUE_IS_EMPTY）或该参数有默认值（AS_HAS_DEFAULT_VALUE）；同时在编写代码读取该参数值时要小心，须判断nArgCount和MDATA_INF.m_dtDataType（否则违反兼容点4,5），大致大代如下：</p><pre><code class=language-c>void fn_Global_SetWindowRgn (PMDATA_INF pRetData, INT nArgCount, PMDATA_INF pArgInf)  
{  
    int nArg1 = pArgInf[0].m_int;  
    int nArg2 = pArgInf[1].m_int;  
    //假设第三个参数是新版添加的参数  
    int nArg3 = 0;  
    if(nArgCount &gt; 2 &amp;&amp; pArgInf[2].m_dtDataType != _SDT_NULL)  
    {  
        nArg3 = pArgInf[2].m_int;  
    }  
    //...  
}  
</code></pre><p>修改一个已有命令的参数时，不能随便修改数据类型，否则将违反兼容点2,3,4,5，要改也只能改成通用型（同时在代码中根据参数传递来的真实类型(MDATA_INF.m_dtDataType)做相应处理）。参数的名称和说明，因为都是文本，可以随便改，有会有兼容性问题，但不要改的意思与原来相反哦（排除原来失误写反了的情况），改变参数语义往往会导致代码改动，进而导致违反兼容点5。</p><h3 id=三-为窗口组件增加属性>三，为窗口组件增加属性</h3><p>新增加的属性，必须放在已有属性的后面，否则违反兼容点4,5，因为易语言运行时是通过属性的索引读写属性值的。然后在序列化属性值时，提高一个版本号，读取时先判断版本，旧版序列化出的数据少，就不能多读。在此提示，序列化属性值时，一定要先写出版本号，如果没有版本号，后续的兼容性问题多多。<br>（TODO：这一段另成一文）但即使有了版本号，使用不当，也会导致升级时的麻烦，我前一段就遇到过，代码有这么一句：if(dwVersion &gt; CURRENT_VER) return FALSE; 版本号比现在能处理的版本号大，出现在什么情况呢，用旧版支持库打开/运行用新版支持库编译的易源程序/程序。返回假是合理的（毕竟不能完全处理这种情况），但是比较粗暴（这意味着无法用旧版支持库打开用新版支持库编写的源程序/程序，这不是向下兼容的问题，是向上兼容的问题），如果能尽量读取，放弃不能识别的数据，温和的处理，效果更好。简单的把这条判断语句删除，有用吗？当然没用，旧版的支持库已经在用户手上了，编译结果是确定的，你的改动只能体现在新版中，而对旧版无能为力。解决这个问题需要技巧，我（liigo）采取的方案是，版本号不升反降！即，把CURRENT_VER减小，那么我序列化出的数据，版本号比以前还小，旧版支持库里的那条判断（if(dwVersion &gt; CURRENT_VER)）就不起作用了，嘿嘿。新的序列化数据版本更低，但写的数据更多，需要担心旧版支持库读出多余的数据来吗？当然不用，旧版支持库的编译结果和运行结果是确定的。只要新版支持库中识别出这种情况，不要因为版本号小就认为是旧版就行了，同时后续升级的方便，再引入一个新的版本号，存到原有序列化数据的最后，这样再次升级时直接判断新版本号就行了，原有的那套版本号停止使用。这一段有点乱，需整理。</p><h3 id=四-为数据类型增加私有成员>四，为数据类型增加私有成员</h3><p>如果某个数据类型已经有了一个或多个私有成员，升级时需要增加一个私有成员，该怎么办，直接在 LIB_DATA_TYPE_ELEMENT 数组中添加一项吗？不行！这样将违反兼容点4,5，因为对象所占用内存是在由EXE分配的，旧的EXE中只为对象分配了N个成员的空间，而新库要去访问第N+1个成员，不就发生内存访问越界的错误了吗？解决方案是，把原来的N个私有成员连用新增加的成员，集中存储到一块新分配的内存中，然后把这个内存地址存储到原有的第一个私有成员位置上（原有的其它成员位置废弃不用）。因为即使是旧EXE也会调用新支持库中的构造函数和析构函数，所以改变私有成员存储位置不会影响程序的执行。这种方案对代码的影响是非常大的，需要修改很多地方（所有对私有成员的读写），但是为了保证支持库的向下兼容性，这种付出是值得的。</p><h3 id=五-为支持库增加常量-或为枚举类型增加常量成员>五，为支持库增加常量，或为枚举类型增加常量成员</h3><p>必须添加到现有常量或常量成员的最后面，否则违反兼容点1,2,3。因为易语言源代码.e文件中记录的是常量在支持库中的索引，一旦在中间插入新的常量，后续常量索引全变了，以前用的这些常量的地方，全错位了，破坏力非常大。但因为常量值是直接编译到EXE/DLL中的，运行时不会去支持库中加载常量，所以不会违反兼容点4,5。</p></div><div class="kratos-copyright text-center clearfix"><h5>本作品采用 <a rel="license nofollow" target=_blank href=https://creativecommons.org/licenses/by-nc-sa/4.0/ title="CC BY-NC-SA 4.0">知识共享署名-非商业性使用-相同方式共享 4.0 国际许可协议</a> 进行许可</h5></div><footer class="kratos-entry-footer clearfix"><div class="post-like-donate text-center clearfix"><a href=javascript:; class=Donate><i class="fa fa-bitcoin"></i>&nbsp;打赏</a></div><div class="footer-tag clearfix"><div class=pull-left><i class="fa fa-tags"></i>&nbsp;
<a href=/tags/%E6%98%93%E8%AF%AD%E8%A8%80.html rel=tag>易语言</a>
<a href=/tags/%E6%94%AF%E6%8C%81%E5%BA%93.html rel=tag>支持库</a></div><div class=pull-date><span title="2019年08月30日 21:57:22">最后编辑：2019年08月30日</span></div></div></footer></div><nav class="navigation post-navigation clearfix" role=navigation><div class="nav-previous clearfix"><a title=杀毒软件已经进入空前弱智与混沌状态 href=/post/25748.html>&lt; 上一篇</a></div><div class=nav-next><a title="E language is what?" href=/post/25746.html>下一篇 &gt;</a></div></nav><div id=comments class=comments-area><div id=comments-body data-pid=/post/25747.html><p class=mClose>评论功能被我吃了。</p></div></div></article></section><aside id=kratos-widget-area class="col-md-4 hidden-xs hidden-sm scrollspy"><div id=sidebar class=affix-top><aside class="widget widget_kratos_about clearfix"><div class=photo-background></div><div class="photo-wrapper clearfix"><div class="photo-wrapper-tip text-center"><a href=javascript:;><img class=about-photo src=/images/avatar.png alt=25H></a></div></div><div class=textwidget><p class=text-center><span style=font-size:10pt>五米雌雄同体，十米人畜不分。</span></p></div></aside><aside class="widget widget_toc clearfix"><h4 class=widget-title>文章目录</h4><div id=TableOfContents></div></aside><aside class="widget widget_categories clearfix"><h4 class=widget-title>分类目录</h4><ul><li><a title=code href=/categories/code.html>code</a></li><li><a title=作品 href=/categories/%E4%BD%9C%E5%93%81.html>作品</a></li><li><a title=未分类 href=/categories/%E6%9C%AA%E5%88%86%E7%B1%BB.html>未分类</a></li><li><a title=状态 href=/categories/%E7%8A%B6%E6%80%81.html>状态</a></li><li><a title=笔记 href=/categories/%E7%AC%94%E8%AE%B0.html>笔记</a></li><li><a title=转载 href=/categories/%E8%BD%AC%E8%BD%BD.html>转载</a></li></ul></aside><aside id=kratos_ad-2 class="widget widget_kratos_ad clearfix"><a href=/z/about.html#打赏-赞助><img class="carousel-inner img-responsive img-rounded" src=/images/rw.jpg></a></aside></div></aside></div></div></div><footer><div id=footer style=background:#23282d><div class=container><div class=row><div class="col-md-6 col-md-offset-3 footer-list text-center"><p class=kratos-social-icons></p><p>© 2022 <a href=https://blog.arae.cc/>ARAE</a>. All Rights Reserved.<br>Powered by <a href=https://gohugo.io/ target=_blank rel=nofollow>Hugo</a> Hosted by <a href=https://pages.github.com target=_blank rel=nofollow>Github Pages</a><br>Theme <a href=https://blog.arae.cc/>Rolla</a> Made by <a href=https://moedog.org/ target=_blank rel=nofollow>Moedog</a> Modified by <a href=https://blog.arae.cc/>25H</a></p></div></div></div><div class="cd-tool text-center"><div class="gotop-box active"><div class=gotop-btn><span class="fa fa-chevron-up"></span></div></div><div class=search-box><span class="fa fa-search"></span><form class=search-form id=searchform target=_blank role=search><input type=text name=wd id=search placeholder=Search... style=display:none></form></div></div></div></footer></div></div></body></html>